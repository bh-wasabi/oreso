{{#define id="notaFactura"}}
  {{param attribute1="=_created.service"}}
  {{param attribute2="=_created.subType"}}
  {{param removeIfEmptySection="articulos"}}
  {{param removeIfEmptyField="cantidad"}}
  {{param startOnOpen="articulos"}}
  {{action id="tool2" condition="true" label="Descargar FEL..." type="save-as" visibleMode="close" color="blue" btnSolid="true" fileName="=(_name||'Factura')+'.fel'" items="=[fn('felTitulos', base), fn('fel', calc.mergeArraysByKey(articulos, _items, 'codigo'))]" flatten="true" fromSource="articulo" fromView="todo"}}

  {{#section id="base"}}
    {{#field id="diasCredito"}}
      {{#onChange}}
        {{set vencimiento="=moment().add(diasCredito,'d').format('YYYY-MM-DD')"}}
      {{/onChange}}
    {{/field}}
  {{/section}}

  {{#section id="articulos"}}
    {{#field id="aliasArticulo"}}
      {{#onChange}}
        {{set articulo="=calc.getPresetPersona('app.aliasArticulo', aliasArticulo, _doc.persona.id).articulo"}}
        {{set codigo="=calc.getPresetPersona('app.aliasArticulo', aliasArticulo, _doc.persona.id).codigo"}}
        {{set descripcion="=calc.getPresetPersona('app.aliasArticulo', aliasArticulo, _doc.persona.id).descripcion"}}
        {{set valorUnitario="=calc.getPresetPersona('app.aliasArticulo', aliasArticulo, _doc.persona.id).precio"}}
      {{/onChange}}
    {{/field}}
    {{#field id="aliasOrigen"}}
      {{#onChange}}
        {{set origen="=calc.getPresetPersona('app.aliasUbicacion', aliasOrigen, _doc.persona.id).ubicacion"}}
        {{set _origen="=calc.getPresetPersona('app.aliasUbicacion', aliasOrigen, _doc.persona.id)._ubicacion"}}
      {{/onChange}}
    {{/field}}
    {{field id="descuentos" type="calc" value="=(valorUnitario*cantidad)*(descuentoLinea/100)"}}
    {{field id="importe" type="calc" value="=(valorUnitario*cantidad)-descuentos"}}
    {{field id="iva" type="calc" value="=importe*(tasaIva/100)"}}
    {{field id="total" type="calc" value="=importe+iva"}}
  {{/section}}
  
  
  {{#grid id="articulos" applyFilter="referencia" keyField="cantidad" section="articulos" allowInsert="false" allowRemove="false" allowSort="true" sortBy="referencia,descripcion"}}
[.#if esOreso.]
    {{column field="referencia" label="Orden Compra" width="150" readOnly="true"}}
    {{column field="referencia2" label="SKU" width="150" readOnly="true"}}
[.else.]
    {{column field="referencia" label="Referencia" width="150" readOnly="true"}}
[./if.]
    {{column field="codigo" label="Código" width="150" readOnly="true"}}
    {{column field="descripcion" label="Artículo" width="350" readOnly="true"}}
    {{column field="_origen" label="Ubicación" width="250" readOnly="true"}}
    {{column field="cantidad" label="Cantidad" width="65" type="numeric" format="#,"}}
    {{column field="valorUnitario" label="Precio Unitario" width="110" type="numeric" format="#,.##" required="true"}}
    {{column field="descuentoLinea" label="% Desc" width="55" type="numeric" format="#.##"}}
    {{column field="tasaIva" label="% IVA" width="50" type="numeric" format="#.##" defaultValue="16" readOnly="true"}}
  {{/grid}}
{{/define}}

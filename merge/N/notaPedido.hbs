{{#define id="notaPedido"}}
  {{param attribute1="=_created.service"}}
  {{param attribute2="=_created.subType"}}
  {{param removeIfEmptySection="articulos"}}
  {{param removeIfEmptyField="cantidad"}}
  {{param startOnOpen="articulos"}}

  {{#section id="base"}}
    {{#field id="diasCredito"}}
      {{#onChange}}
        {{set vencimiento="=moment().add(diasCredito,'d').format('YYYY-MM-DD')"}}
      {{/onChange}}
    {{/field}}
  {{/section}}

  {{#section id="articulos"}}
    {{#field id="aliasArticulo"}}
      {{#onChange}}
        {{set articulo="=calc.getPresetPersona('app.aliasArticulo', aliasArticulo, _doc.persona.id).articulo"}}
        {{set codigo="=calc.getPresetPersona('app.aliasArticulo', aliasArticulo, _doc.persona.id).codigo"}}
        {{set descripcion="=calc.getPresetPersona('app.aliasArticulo', aliasArticulo, _doc.persona.id).descripcion"}}
        {{set valorUnitario="=calc.getPresetPersona('app.aliasArticulo', aliasArticulo, _doc.persona.id).precio"}}
      {{/onChange}}
    {{/field}}
    {{#field id="aliasOrigen"}}
      {{#onChange}}
        {{set origen="=calc.getPresetPersona('app.aliasUbicacion', aliasOrigen, _doc.persona.id).ubicacion"}}
        {{set _origen="=calc.getPresetPersona('app.aliasUbicacion', aliasOrigen, _doc.persona.id)._ubicacion"}}
      {{/onChange}}
    {{/field}}
    {{#field id="aliasDestino"}}
      {{#onChange}}
        {{set destino="=calc.getPresetPersona('app.aliasUbicacion', aliasDestino, _doc.persona.id).ubicacion"}}
        {{set _destino="=calc.getPresetPersona('app.aliasUbicacion', aliasDestino, _doc.persona.id)._ubicacion"}}
      {{/onChange}}
    {{/field}}
    {{field id="importe" type="calc" value="=valorUnitario*cantidad"}}
    {{field id="iva" type="calc" value="=importe*(tasaIva/100)"}}
    {{field id="total" type="calc" value="=importe+iva"}}
    {{field id="faltante" type="calc" value="=_missing||0"}}
    {{field id="neto" type="calc" value="=cantidad-faltante"}}
  {{/section}}
  
  {{#grid id="articulos" section="articulos" keyField="cantidad" allowInsert="true" allowRemove="true"}}
    {{column field="aliasArticulo" label="Artículo" width="150"}}
    {{column field="codigo" label="Código" width="150"}}
    {{column field="descripcion" label="Descripción" width="300"}}
    {{column field="aliasOrigen" label="Origen" width="55" defaultValue="=_params.aliasOrigen"}}
    {{column field="_origen" label="Ubicación" width="150" required="true"}}
    {{column field="aliasDestino" label="Destino" width="55" defaultValue="=_params.aliasDestino"}}
    {{column field="_destino" label="Ubicación" width="150" required="true"}}
    {{column field="cantidad" label="Cantidad" width="65" type="numeric" format="#,"}}
    {{column field="valorUnitario" label="Precio Unitario" width="110" type="numeric" format="#,.##" required="true"}}
    {{column field="tasaIva" label="% IVA" width="45" type="numeric" format="#.##" defaultValue="16"}}
    {{column field="referencia" label="Referencia" width="150"}}
    {{column field="contenedor" label="Contenedor" width="80" type="numeric"}}
    {{column field="cajaInicial" label="Caja Inicial" width="80" type="numeric"}}
    {{column field="cajaFinal" label="Caja Final" width="80" type="numeric"}}
  {{/grid}}

  {{#cube id="articulos" section="articulos" name="=_name||'Pedido'" allowSortingBySummary="true" allowSorting="true" allowFiltering="true" exportToExcel="true" allowExpandAll="true" showColumnGrandTotals="true"}}
    {{column field="_origen" label="Origen"}}
    {{column field="_destino" label="Destino"}}
    {{row field="codigo" label="Código" width="250"}}
    {{row field="descripcion" label="Descripción" width="350"}}
    {{row field="codigoLocal" label="Código Local"}}
    {{row field="codigoUpc" label="Código UPC"}}
    {{sum field="cantidad" label="Cantidad" format="#,"}}
    {{sum field="faltante" label="Faltante" format="#,"}}
    {{sum field="neto" label="Neto" format="#,"}}
    {{sum field="importe" label="Importe" format="currency"}}
  {{/cube}}

  {{#report id="preliminar2" fontSize="8" header="preliminar-encabezado" showStandarFooter="true"}}
    {{#stack}}
      {{image id="logo" url="https://s3.amazonaws.com/mx-imagenes/logos/grupo-oreso.png"}}
    {{/stack}}
    {{#stack}}
      {{#row text="Artículos" fontSize="10" bold="true" margin="-10,0,0,0"}}
      {{/row}}
      {{#table title="Artículos" titleStyle="title" layout="lightHorizontalLines" fontSize="7" section="_items" headerStyle="field" margin="-10,0,0,10" removeEmptyCols="true"}}
        {{column field="codigo" label="Código"}}
        {{column field="descripcion" label="Descripción"}}
        {{column field="codigoUpc" label="Código UPC"}}
        {{column field="referencia" label="Referencia"}}
        {{column field="cantidad" align="right" label="Cantidad"}}
      {{/table}}
    {{/stack}}
  {{/report}}  

  {{action id="tool" condition="true" label="Analizar Pedido" type="viewCube" visibleMode="close" color="cyan" btnSolid="true" cube="articulos" items="=calc.mergeArraysByKey(articulos, _items, 'codigo')" fromSource="articulo" fromView="todo"}}
  {{action id="tool2" condition="true" label="Descargar Checklist..." type="save-as" visibleMode="close" color="blue" btnSolid="true" fileName="=_name||'Pedido'" items="=_.union([fn('checkListTitulos')], fn('checkList', calc.mergeMasterDetail({persona, base}, calc.mergeArraysByKey(articulos, _items, 'codigo'))))" fromSource="articulo" fromView="todo"}}
  {{action id="tool4" condition="true" type="report-pdf" label="Reporte Bodega" report="preliminar2" fileName="=_name" visibleMode="close" color="grey" items="=calc.mapReduce(calc.mergeArraysByKey(articulos, _items, 'codigo'), 'codigo,descripcion,codigoUpc,referencia', 'cantidad')" fromSource="articulo" fromView="todo"}}
{{/define}}